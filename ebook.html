<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多语言故事阅读器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            margin-top: 20px;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            font-size: 2.5rem;
        }
        
        .subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 30px;
            font-size: 1.2rem;
        }
        
        .story-selection {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px dashed #6c757d;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .story-selection:hover {
            border-color: #2575fc;
            background-color: #e9ecef;
        }
        
        .story-selection h2 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .story-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .text-display {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 1.1rem;
            border: 1px solid #dee2e6;
        }
        
        .sentence {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            position: relative;
        }
        
        .word {
            display: inline-block;
            padding: 2px 4px;
            margin: 1px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .word:hover {
            background-color: #e7f3ff;
        }
        
        .word.active {
            background-color: #cfe2ff;
            color: #0d6efd;
            font-weight: bold;
        }
        
        .sentence-end {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            background-color: #f8f9fa;
            cursor: pointer;
            margin-left: 5px;
            transition: all 0.3s;
            font-weight: bold;
            color: #495057;
            border: 2px solid #dee2e6;
        }
        
        .sentence-end:hover {
            background-color: #2575fc;
            color: white;
            border-color: #1a68e3;
            transform: scale(1.1);
        }
        
        .sentence-end.active {
            background-color: #2575fc;
            color: white;
            border-color: #1a68e3;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            background-color: #2575fc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        button:hover {
            background-color: #1a68e3;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            font-size: 1rem;
        }
        
        .status {
            text-align: center;
            margin-top: 15px;
            color: #6c757d;
            font-style: italic;
        }
        
        .instructions {
            background-color: #e7f3ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #2575fc;
        }
        
        .instructions h3 {
            color: #0d6efd;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .language-tag {
            display: inline-block;
            background-color: #6f42c1;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .controls, .voice-controls, .story-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>多语言故事阅读器</h1>
    <p class="subtitle">支持英文和法文 - 点击单词朗读单词，点击句尾朗读句子</p>
    
    <div class="container">
        <div class="story-selection">
            <h2>选择故事</h2>
            <div class="story-controls">
                <label for="storySelect">选择故事：</label>
                <select id="storySelect">
                    <option value="">-- 请选择故事 --</option>
                </select>
                <button id="refreshBtn">刷新故事列表</button>
            </div>
        </div>
        
        <div class="instructions">
            <h3>使用说明</h3>
            <ul>
                <li>从下拉菜单中选择英文或法文故事</li>
                <li><strong>点击单词</strong> - 朗读单个单词</li>
                <li><strong>点击句尾符号（●）</strong> - 朗读整个句子</li>
                <li>使用控制按钮播放、暂停或停止朗读</li>
                <li>可以选择不同的语音和语速</li>
                <li>管理员可以通过修改 stories.json 文件来添加或修改故事</li>
            </ul>
        </div>
        
        <div class="text-display" id="textDisplay">
            <p style="text-align: center; color: #6c757d; margin-top: 150px;">
                请选择一个故事开始阅读
            </p>
        </div>
        
        <div class="voice-controls">
            <label for="voiceSelect">选择语音：</label>
            <select id="voiceSelect"></select>
            <label for="rateSelect">语速：</label>
            <select id="rateSelect">
                <option value="0.5">慢速</option>
                <option value="1" selected>正常</option>
                <option value="1.5">快速</option>
                <option value="2">极快</option>
            </select>
        </div>
        
        <div class="controls">
            <button id="playBtn" disabled>播放全文</button>
            <button id="pauseBtn" disabled>暂停</button>
            <button id="resumeBtn" disabled>继续</button>
            <button id="stopBtn" disabled>停止</button>
        </div>
        
        <div class="status" id="status">准备就绪</div>
    </div>

    <script>
        // 获取DOM元素
        const storySelect = document.getElementById('storySelect');
        const refreshBtn = document.getElementById('refreshBtn');
        const textDisplay = document.getElementById('textDisplay');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateSelect = document.getElementById('rateSelect');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        
        // 初始化语音合成
        let speechSynthesis = window.speechSynthesis;
        let speechUtterance = null;
        let sentences = [];
        let currentSentenceIndex = -1;
        let voices = [];
        let stories = {};
        let currentStory = null;
        
        // 加载故事数据
        async function loadStories() {
            try {
                // 从同目录下的 stories.json 文件加载故事
                const response = await fetch('ebook.json');
                if (!response.ok) {
                    throw new Error('无法加载故事数据');
                }
                stories = await response.json();
                populateStorySelect();
                status.textContent = `已加载 ${Object.keys(stories).length} 个故事`;
            } catch (error) {
                console.error('加载故事失败:', error);
                status.textContent = '加载故事失败，使用默认故事';
                
                // 使用默认故事作为后备
                stories = getDefaultStories();
                populateStorySelect();
            }
        }
        
        // 默认故事数据（后备方案）
        function getDefaultStories() {
            return {
                "english_tortoise": {
                    "title": "The Tortoise and the Hare (English)",
                    "language": "en-US",
                    "content": "Once upon a time, there was a hare who was very proud of his speed. He often made fun of the tortoise for being so slow. One day, the tortoise got tired of the hare's teasing and challenged him to a race. The hare laughed and accepted the challenge. All the animals in the forest gathered to watch the race. The fox was chosen as the referee. He marked the starting and finishing points, and the race began. The hare quickly ran ahead and was soon out of sight. He thought to himself, 'The tortoise is so slow. I have time to take a nap.' So the hare found a shady tree and lay down for a nap. He was sure he would win the race easily. Meanwhile, the tortoise kept moving slowly but steadily. He didn't stop for a moment. When the hare woke up, he saw the tortoise was near the finish line. He ran as fast as he could, but it was too late. The tortoise had already crossed the finish line. The moral of the story is: slow and steady wins the race."
                },
                "french_lion": {
                    "title": "Le Lion et le Rat (French)",
                    "language": "fr-FR",
                    "content": "Un lion, un jour, dormait dans son antre. Un rat, par hasard, vint à passer. Il grimpa sur le corps du lion, et se mit à courir et à jouer. Le lion se réveilla en sursaut. Il attrapa le rat et s'apprêta à le dévorer. Le rat implora pitié. 'Ô roi des animaux, épargne-moi, je t'en prie ! Un jour, peut-être, je pourrai te rendre service.' Le lion, amusé par cette idée, décida de libérer le petit rat. Quelque temps après, le lion fut pris dans un filet de chasseurs. Il rugit de toutes ses forces, mais ne put se libérer. Le rat entendit ses cris. Il accourut et se mit à ronger les cordes du filet. Peu à peu, il fit un trou assez grand pour que le lion puisse s'échapper. La moralité de cette histoire : on a toujours besoin d'un plus petit que soi."
                },
                "english_ants": {
                    "title": "The Ant and the Grasshopper (English)",
                    "language": "en-US",
                    "content": "One bright day in late autumn, a family of ants was bustling about in the warm sunshine. They were drying out the grain they had stored up during the summer. A grasshopper, half dead with hunger, came by. He asked the ants for a morsel to save his life. 'What did you do all summer?' asked the ants. 'I sang day and night,' replied the grasshopper. 'If you sang all summer,' said the ants, 'you can dance all winter!' The moral: There's a time for work and a time for play."
                }
            };
        }
        
        // 填充故事选择下拉菜单
        function populateStorySelect() {
            storySelect.innerHTML = '<option value="">-- 请选择故事 --</option>';
            
            Object.keys(stories).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = stories[key].title;
                storySelect.appendChild(option);
            });
        }
        
        // 加载可用语音
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            voiceSelect.innerHTML = '';
            
            // 根据当前故事的语言过滤语音
            if (currentStory) {
                const filteredVoices = voices.filter(voice => {
                    return voice.lang.includes(currentStory.language);
                });
                
                if (filteredVoices.length > 0) {
                    filteredVoices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.name;
                        option.textContent = `${voice.name} (${voice.lang})`;
                        voiceSelect.appendChild(option);
                    });
                }
            }
            
            // 如果没有匹配的语音，显示所有可用语音
            if (voiceSelect.options.length === 0) {
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
            }
        }
        
        // 语音加载事件
        speechSynthesis.onvoiceschanged = loadVoices;
        
        // 故事选择处理
        storySelect.addEventListener('change', function(e) {
            const selectedStory = e.target.value;
            if (selectedStory && stories[selectedStory]) {
                currentStory = stories[selectedStory];
                processText(currentStory.content, currentStory.language);
                status.textContent = `已加载: ${currentStory.title}`;
            } else {
                textDisplay.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 150px;">请选择一个故事开始阅读</p>';
                playBtn.disabled = true;
                currentStory = null;
            }
        });
        
        // 刷新故事列表
        refreshBtn.addEventListener('click', () => {
            loadStories();
        });
        
        // 处理文本，分割成句子和单词
        function processText(text, language) {
            // 根据语言使用不同的句子分割规则
            let sentenceRegex;
            if (language === 'fr-FR') {
                sentenceRegex = /(?<=[.!?])/;
            } else {
                sentenceRegex = /(?<=[.!?])/;
            }
            
            sentences = text.split(sentenceRegex).filter(s => s.trim().length > 0);
            
            // 清空文本显示区域
            textDisplay.innerHTML = '';
            
            // 创建句子元素
            sentences.forEach((sentence, index) => {
                const sentenceElement = document.createElement('div');
                sentenceElement.className = 'sentence';
                
                // 分割句子为单词
                const words = sentence.trim().split(/\s+/);
                
                // 创建单词元素
                words.forEach((word, wordIndex) => {
                    const wordElement = document.createElement('span');
                    wordElement.className = 'word';
                    wordElement.textContent = word;
                    
                    // 添加点击事件朗读单词
                    wordElement.addEventListener('click', () => {
                        speakWord(word, index, wordIndex);
                    });
                    
                    sentenceElement.appendChild(wordElement);
                    sentenceElement.appendChild(document.createTextNode(' '));
                });
                
                // 添加句尾按钮
                const sentenceEnd = document.createElement('span');
                sentenceEnd.className = 'sentence-end';
                sentenceEnd.textContent = '●';
                sentenceEnd.title = '点击朗读整个句子';
                sentenceEnd.dataset.sentenceIndex = index;
                
                // 添加点击事件朗读整个句子
                sentenceEnd.addEventListener('click', () => {
                    speakSentence(index);
                });
                
                sentenceElement.appendChild(sentenceEnd);
                textDisplay.appendChild(sentenceElement);
            });
            
            // 重新加载语音列表
            loadVoices();
            
            // 启用播放按钮
            playBtn.disabled = false;
        }
        
        // 朗读单词
        function speakWord(word, sentenceIndex, wordIndex) {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            // 移除之前的高亮
            document.querySelectorAll('.word.active').forEach(el => {
                el.classList.remove('active');
            });
            
            // 高亮当前单词
            const currentSentence = document.querySelectorAll('.sentence')[sentenceIndex];
            const currentWord = currentSentence.querySelectorAll('.word')[wordIndex];
            currentWord.classList.add('active');
            
            // 滚动到当前单词
            currentWord.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // 创建语音合成实例
            speechUtterance = new SpeechSynthesisUtterance(word);
            
            // 设置语音参数
            const selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
            if (selectedVoice) {
                speechUtterance.voice = selectedVoice;
            }
            
            speechUtterance.rate = parseFloat(rateSelect.value);
            speechUtterance.pitch = 1;
            speechUtterance.volume = 1;
            speechUtterance.lang = currentStory.language;
            
            // 设置事件处理
            speechUtterance.onstart = () => {
                status.textContent = `正在朗读单词: ${word}`;
                updateControlButtons(true);
            };
            
            speechUtterance.onend = () => {
                status.textContent = '单词朗读完成';
                currentWord.classList.remove('active');
                updateControlButtons(false);
            };
            
            speechUtterance.onerror = (event) => {
                status.textContent = `朗读出错: ${event.error}`;
                currentWord.classList.remove('active');
                updateControlButtons(false);
            };
            
            // 开始朗读
            speechSynthesis.speak(speechUtterance);
        }
        
        // 朗读指定句子
        function speakSentence(index) {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            // 移除之前的高亮
            document.querySelectorAll('.sentence-end.active').forEach(el => {
                el.classList.remove('active');
            });
            
            // 高亮当前句尾
            const currentSentenceEnd = document.querySelector(`.sentence-end[data-sentence-index="${index}"]`);
            currentSentenceEnd.classList.add('active');
            
            // 滚动到当前句子
            currentSentenceEnd.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // 创建语音合成实例
            speechUtterance = new SpeechSynthesisUtterance(sentences[index]);
            
            // 设置语音参数
            const selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
            if (selectedVoice) {
                speechUtterance.voice = selectedVoice;
            }
            
            speechUtterance.rate = parseFloat(rateSelect.value);
            speechUtterance.pitch = 1;
            speechUtterance.volume = 1;
            speechUtterance.lang = currentStory.language;
            
            // 设置事件处理
            speechUtterance.onstart = () => {
                status.textContent = `正在朗读句子: ${sentences[index].substring(0, 30)}...`;
                currentSentenceIndex = index;
                updateControlButtons(true);
            };
            
            speechUtterance.onend = () => {
                status.textContent = '句子朗读完成';
                currentSentenceEnd.classList.remove('active');
                currentSentenceIndex = -1;
                updateControlButtons(false);
            };
            
            speechUtterance.onerror = (event) => {
                status.textContent = `朗读出错: ${event.error}`;
                currentSentenceEnd.classList.remove('active');
                currentSentenceIndex = -1;
                updateControlButtons(false);
            };
            
            // 开始朗读
            speechSynthesis.speak(speechUtterance);
        }
        
        // 更新控制按钮状态
        function updateControlButtons(isSpeaking) {
            if (isSpeaking) {
                playBtn.disabled = true;
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
                stopBtn.disabled = false;
            } else {
                playBtn.disabled = false;
                pauseBtn.disabled = true;
                resumeBtn.disabled = true;
                stopBtn.disabled = true;
            }
        }
        
        // 播放按钮事件
        playBtn.addEventListener('click', () => {
            if (sentences.length > 0) {
                speakSentence(0);
            }
        });
        
        // 暂停按钮事件
        pauseBtn.addEventListener('click', () => {
            if (speechSynthesis.speaking) {
                speechSynthesis.pause();
                pauseBtn.disabled = true;
                resumeBtn.disabled = false;
                status.textContent = '已暂停';
            }
        });
        
        // 继续按钮事件
        resumeBtn.addEventListener('click', () => {
            if (speechSynthesis.paused) {
                speechSynthesis.resume();
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
                status.textContent = '继续朗读';
            }
        });
        
        // 停止按钮事件
        stopBtn.addEventListener('click', () => {
            if (speechSynthesis.speaking || speechSynthesis.paused) {
                speechSynthesis.cancel();
                document.querySelectorAll('.word.active, .sentence-end.active').forEach(el => {
                    el.classList.remove('active');
                });
                status.textContent = '已停止';
                updateControlButtons(false);
            }
        });
        
        // 初始化
        loadStories();
        loadVoices();
    </script>
</body>
</html>