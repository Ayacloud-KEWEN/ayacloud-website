<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››å·éº»å°†ï¼šè¡€æˆ˜åˆ°åº•</title>
    <style>
        :root {
            --table-bg: #1e5e35;
            --mat-texture: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, transparent 60%);
            --tile-w: 36px;
            --tile-h: 48px;
            --tile-d: 6px; /* åšåº¦ */
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #111;
            font-family: "Helvetica Neue", sans-serif;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* éº»å°†æ¡Œ */
        .table {
            width: 100vw;
            height: 100vh;
            background-color: var(--table-bg);
            background-image: var(--mat-texture);
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        /* ä¸­å¿ƒä¿¡æ¯åŒº */
        .center-info {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 120px; height: 120px;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 10px;
            background: rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
        .wall-count { font-size: 24px; color: #ffd700; font-weight: bold; }

        /* ç©å®¶åŒºåŸŸå¸ƒå±€ */
        .player-area {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* å¤´åƒä¸å®šç¼ºçŠ¶æ€ */
        .avatar-box {
            position: absolute;
            width: 50px; height: 50px;
            background: #333;
            border: 2px solid #666;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            z-index: 10;
        }
        .que-mark {
            position: absolute;
            top: -10px; right: -10px;
            width: 20px; height: 20px;
            border-radius: 50%;
            background: #ff4444;
            color: white;
            font-size: 12px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            display: none; /* é»˜è®¤éšè— */
        }
        .hu-mark {
            position: absolute;
            bottom: -10px; left: 50%; transform: translateX(-50%);
            background: #ffd700;
            color: #b00;
            padding: 2px 5px;
            font-size: 10px;
            border-radius: 4px;
            font-weight: bold;
            display: none;
            white-space: nowrap;
        }

        /* 4ä¸ªæ–¹ä½çš„å…·ä½“ä½ç½® */
        /* ä¸‹æ–¹ï¼ˆç©å®¶ï¼‰ */
        .p-bottom { bottom: 10px; left: 0; width: 100%; height: 80px; flex-direction: column; justify-content: flex-end; }
        .p-bottom .avatar-box { left: 10px; bottom: 20px; }
        .p-bottom .hand { margin-bottom: 10px; }
        
        /* ä¸Šæ–¹ï¼ˆæœºå™¨äººï¼‰ */
        .p-top { top: 10px; left: 0; width: 100%; height: 60px; transform: rotate(180deg); }
        .p-top .avatar-box { left: 10px; bottom: 5px; transform: rotate(180deg); }

        /* å·¦æ–¹ */
        .p-left { top: 0; left: 10px; width: 60px; height: 100%; flex-direction: column; transform: rotate(90deg); }
        .p-left .avatar-box { left: 10px; bottom: 10px; transform: rotate(-90deg); }

        /* å³æ–¹ */
        .p-right { top: 0; right: 10px; width: 60px; height: 100%; flex-direction: column; transform: rotate(-90deg); }
        .p-right .avatar-box { left: 10px; bottom: 10px; transform: rotate(90deg); }

        /* æ‰‹ç‰Œå®¹å™¨ */
        .hand {
            display: flex;
            gap: -2px;
            height: var(--tile-h);
            align-items: flex-end;
            perspective: 600px;
        }

        /* å¼ƒç‰Œå † */
        .discard-pile {
            position: absolute;
            display: flex;
            flex-wrap: wrap;
            width: 180px;
            height: 90px;
            gap: 2px;
            justify-content: center;
            align-content: center;
        }
        .d-bottom { bottom: 130px; left: 50%; transform: translateX(-50%); }
        .d-top { top: 130px; left: 50%; transform: translateX(-50%) rotate(180deg); }
        .d-left { left: 130px; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .d-right { right: 130px; top: 50%; transform: translateY(-50%) rotate(-90deg); }


        /* éº»å°†ç‰Œæ ·å¼ */
        .tile {
            width: var(--tile-w);
            height: var(--tile-h);
            position: relative;
            margin: 0 1px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.2s, margin 0.2s;
        }

        /* ç‰Œçš„å®ä½“ */
        .tile-inner {
            width: 100%;
            height: 100%;
            background: #f0f0f0; /* ç‰Œé¢è‰² */
            border-radius: 4px;
            box-shadow: 
                1px 1px 0 #bbb, 
                2px 2px 0 #999, /* æ¨¡æ‹Ÿåšåº¦ */
                2px 4px 5px rgba(0,0,0,0.4); /* é˜´å½± */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: #333;
            overflow: hidden;
            box-sizing: border-box;
            border: 1px solid #ddd;
        }
        
        /* ç‰ŒèƒŒ */
        .tile.back .tile-inner {
            background: #2c6e9e; /* è“è‰²ç‰ŒèƒŒ */
            border: 1px solid #1a4d75;
            box-shadow: 1px 1px 0 #1a4d75, 2px 2px 0 #0f3350, 2px 4px 5px rgba(0,0,0,0.4);
        }
        .tile.back .tile-inner::after {
            content: ''; /* ç®€å•çš„èŠ±çº¹ */
            width: 80%; height: 80%;
            border: 1px dashed rgba(255,255,255,0.3);
            border-radius: 2px;
        }

        /* èººç€çš„ç‰Œ (ç¢°/æ /å¼ƒ) */
        .tile.ground {
            width: 28px; height: 38px;
        }
        .tile.ground .tile-inner {
            font-size: 22px;
            background: #e6e6e6;
        }

        /* é€‰ä¸­çš„ç‰Œ */
        .tile.selected {
            transform: translateY(-15px);
        }
        /* æ‘¸æ¥çš„ç‰Œ (ç¨å¾®éš”å¼€) */
        .tile.new-draw {
            margin-left: 15px;
        }
        
        /* ç¦ç”¨çš„ç‰Œ (å®šç¼ºæ—¶éç¼ºç‰Œï¼Œæˆ–æ²¡è½®åˆ°ä½ ) */
        .tile.disabled .tile-inner {
            background: #ccc;
            color: rgba(0,0,0,0.2);
        }

        /* èŠ±è‰²é¢œè‰² */
        .suit-0 { color: #b31010; } /* ä¸‡ - çº¢ */
        .suit-1 { color: #1a66b3; } /* ç­’ - è“/é»‘ */
        .suit-2 { color: #2a8a2a; } /* æ¡ - ç»¿ */

        /* æ“ä½œé¢æ¿ */
        .action-panel {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: none; /* JSæ§åˆ¶ */
            gap: 15px;
            z-index: 100;
        }

        .btn {
            width: 60px; height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            font-weight: bold;
            font-size: 20px;
            color: white;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.9); }
        .btn-hu { background: #ff4444; font-size: 24px; animation: pulse 1s infinite; }
        .btn-gang { background: #ffaa00; }
        .btn-peng { background: #4facfe; }
        .btn-pass { background: #999; font-size: 16px; }

        /* å®šç¼ºé¢æ¿ */
        .dingque-panel {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .dq-options { display: flex; gap: 20px; margin-top: 30px; }
        .dq-btn {
            width: 80px; height: 100px;
            background: #eee;
            color: #333;
            border-radius: 10px;
            font-size: 40px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }
        
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        /* èƒ¡ç‰ŒåŠ¨ç”»æ–‡å­— */
        .hu-anim {
            position: absolute;
            font-size: 80px;
            font-weight: bold;
            color: gold;
            text-shadow: 0 0 20px red;
            opacity: 0;
            pointer-events: none;
            z-index: 300;
            transition: all 0.5s;
        }
        .hu-anim.show { opacity: 1; transform: scale(1.5); }

    </style>
</head>
<body>

    <div class="table">
        <div class="center-info">
            <div style="margin-bottom:5px">è¡€æˆ˜åˆ°åº•</div>
            <div class="wall-count" id="wall-count">108</div>
            <div style="font-size:12px; margin-top:5px" id="turn-indicator">å‡†å¤‡å¼€å§‹</div>
        </div>

        <div class="player-area p-top">
            <div class="avatar-box">
                Bot3
                <div class="que-mark" id="que-3"></div>
                <div class="hu-mark" id="hu-3">èƒ¡</div>
            </div>
            <div class="hand" id="hand-3"></div>
        </div>
        <div class="discard-pile d-top" id="disc-3"></div>

        <div class="player-area p-left">
            <div class="avatar-box">
                Bot2
                <div class="que-mark" id="que-2"></div>
                <div class="hu-mark" id="hu-2">èƒ¡</div>
            </div>
            <div class="hand" id="hand-2"></div>
        </div>
        <div class="discard-pile d-left" id="disc-2"></div>

        <div class="player-area p-right">
            <div class="avatar-box">
                Bot1
                <div class="que-mark" id="que-1"></div>
                <div class="hu-mark" id="hu-1">èƒ¡</div>
            </div>
            <div class="hand" id="hand-1"></div>
        </div>
        <div class="discard-pile d-right" id="disc-1"></div>

        <div class="player-area p-bottom">
            <div class="avatar-box">
                æˆ‘
                <div class="que-mark" id="que-0"></div>
                <div class="hu-mark" id="hu-0">èƒ¡</div>
            </div>
            <div class="hand" id="hand-0"></div>
        </div>
        <div class="discard-pile d-bottom" id="disc-0"></div>
        
        <div class="action-panel" id="action-panel">
            </div>

        <div class="hu-anim" id="hu-effect">èƒ¡!</div>
    </div>

    <div class="dingque-panel" id="dq-panel">
        <h2>è¯·é€‰æ‹©ä¸€é—¨ä¸éœ€è¦çš„ç‰Œ (å®šç¼º)</h2>
        <div class="dq-options">
            <div class="dq-btn suit-0" onclick="userSelectQue(0)">ä¸‡</div>
            <div class="dq-btn suit-1" onclick="userSelectQue(1)">ç­’</div>
            <div class="dq-btn suit-2" onclick="userSelectQue(2)">æ¡</div>
        </div>
    </div>

    <script>
        // --- åŸºç¡€æ•°æ®ç»“æ„ ---
        // 0: ä¸‡, 1: ç­’, 2: æ¡
        // Unicode: ä¸‡(1F007-1F00F), æ¡(1F010-1F018), ç­’(1F019-1F021)
        const SUIT_CHARS = [
            ['ğŸ€‡','ğŸ€ˆ','ğŸ€‰','ğŸ€Š','ğŸ€‹','ğŸ€Œ','ğŸ€','ğŸ€','ğŸ€'], // ä¸‡
            ['ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡'], // ç­’
            ['ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜']  // æ¡
        ];
        
        const SUIT_NAMES = ['ä¸‡', 'ç­’', 'æ¡'];

        class Tile {
            constructor(suit, value) {
                this.suit = suit; // 0, 1, 2
                this.value = value; // 1-9
                this.uid = Math.random().toString(36).substr(2, 9); // å”¯ä¸€IDç”¨äºDOM
            }
            
            // æ’åºæƒé‡: ä¸‡ < ç­’ < æ¡
            get sortValue() {
                return this.suit * 10 + this.value;
            }

            get char() {
                return SUIT_CHARS[this.suit][this.value - 1];
            }
        }

        // --- å…¨å±€çŠ¶æ€ ---
        let wall = [];
        let players = []; // 0: Human, 1,2,3: Bots
        let turnIndex = 0; // 0-3
        let phase = 'deal'; // deal, dingque, play, over
        let lastDiscard = null; // {tile, fromPlayerIdx}
        let winners = []; // å·²ç»èƒ¡ç‰Œçš„ç©å®¶ç´¢å¼•

        // --- åˆå§‹åŒ–æ¸¸æˆ ---
        function initGame() {
            // 1. æ´—ç‰Œ (108å¼ : 3èŠ±è‰² * 9æ•°å€¼ * 4å¼ )
            wall = [];
            for (let s = 0; s < 3; s++) {
                for (let v = 1; v <= 9; v++) {
                    for (let k = 0; k < 4; k++) {
                        wall.push(new Tile(s, v));
                    }
                }
            }
            shuffle(wall);

            // 2. åˆå§‹åŒ–ç©å®¶
            players = [];
            for (let i = 0; i < 4; i++) {
                players.push({
                    id: i,
                    hand: [],
                    peng: [], // ç¢°/æ çš„ç‰Œ
                    discards: [],
                    que: -1, // å®šç¼ºçš„èŠ±è‰²
                    hasHu: false,
                    isBot: i !== 0
                });
            }

            // 3. å‘ç‰Œ (æ¯äºº13å¼ )
            for (let i = 0; i < 13; i++) {
                for (let p = 0; p < 4; p++) {
                    players[p].hand.push(wall.pop());
                }
            }
            
            // æ’åºæ‰‹ç‰Œ
            players.forEach(p => sortHand(p.hand));
            
            updateUI();
            startDingQue();
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function sortHand(hand) {
            hand.sort((a, b) => a.sortValue - b.sortValue);
        }

        // --- å®šç¼ºé˜¶æ®µ ---
        function startDingQue() {
            phase = 'dingque';
            document.getElementById('dq-panel').style.display = 'flex';
            
            // æœºå™¨äººå®šç¼ºé€»è¾‘ï¼šé€‰èŠ±è‰²æœ€å°‘çš„é‚£é—¨
            for (let i = 1; i < 4; i++) {
                const counts = [0, 0, 0];
                players[i].hand.forEach(t => counts[t.suit]++);
                // æ‰¾æ•°é‡æœ€å°‘çš„ï¼ˆå¦‚æœæœ‰0å¼ ç›´æ¥é€‰ï¼Œå¦åˆ™é€‰æœ€å°‘çš„ï¼‰
                let min = 14, minSuit = 0;
                for(let s=0; s<3; s++){
                    if(counts[s] < min) { min = counts[s]; minSuit = s; }
                }
                players[i].que = minSuit;
            }
        }

        function userSelectQue(suit) {
            players[0].que = suit;
            document.getElementById('dq-panel').style.display = 'none';
            finishDingQue();
        }

        function finishDingQue() {
            // æ˜¾ç¤ºå®šç¼ºå›¾æ ‡
            for(let i=0; i<4; i++){
                const qEl = document.getElementById(`que-${i}`);
                qEl.innerText = SUIT_NAMES[players[i].que];
                qEl.className = `que-mark suit-${players[i].que}`;
                qEl.style.display = 'flex';
            }

            phase = 'play';
            turnIndex = 0; // åº„å®¶å…ˆæ‰‹ï¼ˆç®€åŒ–å›ºå®šä¸º0ï¼‰
            drawTile(turnIndex);
        }

        // --- æ¸¸æˆä¸»å¾ªç¯ ---

        function drawTile(pIdx) {
            // è¡€æˆ˜è§„åˆ™ï¼šå¦‚æœç‰Œå¢™æ²¡äº†ï¼Œæ¸¸æˆç»“æŸ
            if (wall.length === 0) {
                endGame();
                return;
            }
            
            // å¦‚æœè¯¥ç©å®¶å·²ç»èƒ¡äº†ï¼Œè·³è¿‡
            if (players[pIdx].hasHu) {
                nextTurn();
                return;
            }

            updateWallCount();

            const newTile = wall.pop();
            players[pIdx].hand.push(newTile);
            // æš‚ä¸æ’åºï¼ŒæŠŠæ–°æ‘¸çš„æ”¾åœ¨æœ€åæ–¹ä¾¿UIæ˜¾ç¤º

            updateUI();
            
            // æ£€æŸ¥è‡ªæ‘¸èƒ¡ / æ 
            if (pIdx === 0) {
                checkSelfActions(newTile);
            } else {
                setTimeout(() => botPlay(pIdx, newTile), 800);
            }
        }

        function discardTile(pIdx, tileIndex) {
            const p = players[pIdx];
            const tile = p.hand.splice(tileIndex, 1)[0];
            sortHand(p.hand); // æ•´ç†æ‰‹ç‰Œ
            
            p.discards.push(tile);
            lastDiscard = { tile: tile, from: pIdx };
            
            updateUI();

            // æ£€æŸ¥å…¶ä»–äººæ˜¯å¦å¯ä»¥ ç¢°/æ /èƒ¡
            checkOtherActions(pIdx, tile);
        }

        function nextTurn() {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æœªèƒ¡ç©å®¶éƒ½å·²ç»æŸ¥è¿‡
            let activePlayers = players.filter(p => !p.hasHu).length;
            if (activePlayers <= 1) {
                endGame(); // å‰©ä¸€å®¶æˆ–éƒ½èƒ¡äº†
                return;
            }

            turnIndex = (turnIndex + 1) % 4;
            drawTile(turnIndex);
        }

        // --- é€»è¾‘åˆ¤æ–­ ---

        // ç®€å•èƒ¡ç‰Œç®—æ³• (4é¢å­+1é›€å¤´)
        // å¿…é¡»ç¼ºä¸€é—¨ï¼Œä¸èƒ½æœ‰å®šç¼ºèŠ±è‰²çš„ç‰Œ
        function canHu(hand, queSuit) {
            // 1. æ£€æŸ¥æ˜¯å¦æœ‰ç¼ºé—¨ç‰Œ
            for (let t of hand) {
                if (t.suit === queSuit) return false;
            }

            // 2. æ‹·è´æ‰‹ç‰Œè¿›è¡Œè®¡ç®—
            // å°†æ‰‹ç‰Œè½¬åŒ–ä¸º counts æ•°ç»„ [suit][val]
            let counts = [[0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0], [0,0,0,0,0,0,0,0,0,0]];
            for(let t of hand) {
                counts[t.suit][t.value]++;
            }

            // å°è¯•ä»¥æ¯ä¸€å¯¹åšå°†
            for (let s = 0; s < 3; s++) {
                for (let v = 1; v <= 9; v++) {
                    if (counts[s][v] >= 2) {
                        counts[s][v] -= 2; // ç§»é™¤å°†
                        if (checkMelds(counts)) return true;
                        counts[s][v] += 2; // å›æº¯
                    }
                }
            }
            return false;
        }

        function checkMelds(counts) {
            for (let s = 0; s < 3; s++) {
                for (let v = 1; v <= 9; v++) {
                    if (counts[s][v] > 0) {
                        // åˆ»å­
                        if (counts[s][v] >= 3) {
                            counts[s][v] -= 3;
                            if (checkMelds(counts)) return true;
                            counts[s][v] += 3;
                        }
                        // é¡ºå­ (åªæœ‰ä¸‡ç­’æ¡å¯ä»¥é¡ºï¼Œè¿™é‡Œéƒ½æ˜¯)
                        if (v <= 7 && counts[s][v+1] > 0 && counts[s][v+2] > 0) {
                            counts[s][v]--; counts[s][v+1]--; counts[s][v+2]--;
                            if (checkMelds(counts)) return true;
                            counts[s][v]++; counts[s][v+1]++; counts[s][v+2]++;
                        }
                        return false; // å¦‚æœè¿˜æœ‰ç‰Œä½†æ— æ³•ç»„æˆåˆ»å­æˆ–é¡ºå­
                    }
                }
            }
            return true; // æ‰€æœ‰ç‰Œéƒ½ç”¨å®Œäº†
        }

        // --- ç©å®¶äº¤äº’ ---

        function checkSelfActions(newTile) {
            const p = players[0];
            const actionPanel = document.getElementById('action-panel');
            actionPanel.innerHTML = '';
            let hasAction = false;

            // 1. æ£€æŸ¥èƒ¡ (è‡ªæ‘¸)
            if (canHu(p.hand, p.que)) {
                addActionButton('èƒ¡', 'btn-hu', () => performHu(0, newTile, true));
                hasAction = true;
            }

            // 2. æ£€æŸ¥æš—æ  (ç”±äºç®€åŒ–ï¼Œè¿™é‡Œæš‚ä¸å¤„ç†åŠ æ ï¼Œåªå¤„ç†æ‰‹é‡Œ4å¼ ä¸€æ ·çš„)
            // ä¸ºäº†ç®€åŒ–demoï¼Œæ é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæš‚åªåšâ€œç¢°â€å’Œâ€œèƒ¡â€
            // å¦‚æœè¦åŠ æ ï¼Œé€»è¾‘å¤ªå¤šã€‚è¿™é‡ŒåªåšåŸºç¡€èƒ¡ç‰Œæ¼”ç¤ºã€‚

            if (hasAction) {
                addActionButton('è¿‡', 'btn-pass', () => {
                    actionPanel.style.display = 'none';
                    // ç”¨æˆ·å¿…é¡»æ‰“å‡ºä¸€å¼ ç‰Œ
                    enableHandClick();
                });
                actionPanel.style.display = 'flex';
            } else {
                enableHandClick();
            }
        }

        function checkOtherActions(fromIdx, tile) {
            // è¡€æˆ˜è§„åˆ™ï¼šèƒ¡ > ç¢°/æ 
            // å¤šäººå¯ä»¥åŒæ—¶èƒ¡ (ä¸€ç‚®å¤šå“)
            
            let canHuList = [];
            
            // æ£€æŸ¥å…¶ä»–äººèƒ½å¦èƒ¡
            for (let i = 0; i < 4; i++) {
                if (i === fromIdx || players[i].hasHu) continue;
                
                // æ¨¡æ‹ŸæŠŠç‰ŒåŠ å…¥æ‰‹ç‰Œæ£€æŸ¥
                let tempHand = [...players[i].hand, tile];
                sortHand(tempHand);
                if (canHu(tempHand, players[i].que)) {
                    canHuList.push(i);
                }
            }

            // ç©å®¶æ“ä½œä¼˜å…ˆçº§
            if (canHuList.includes(0)) {
                showHuPrompt(tile, canHuList);
                return; // ç­‰å¾…ç©å®¶å†³å®š
            }

            // å¦‚æœç©å®¶ä¸èƒ½èƒ¡ï¼Œå¤„ç†æœºå™¨äººèƒ¡
            if (canHuList.length > 0) {
                // æœºå™¨äººç›´æ¥èƒ¡
                canHuList.forEach(idx => performHu(idx, tile, false));
                // ä¸€ç‚®å¤šå“åï¼Œå‡ºç‰Œæƒç»™ä¸‹å®¶
                if (players[turnIndex].hasHu) { 
                     // å¦‚æœå‡ºç‰Œè€…ä¸‹å®¶èƒ¡äº†ï¼Œç»§ç»­æµè½¬
                }
                // ç®€å•å¤„ç†ï¼šåªè¦æœ‰äººèƒ¡ï¼Œç‰Œå°±è¢«æ¶ˆæ‰äº†ï¼Œæµç¨‹ç»§ç»­
                nextTurn();
                return;
            }

            // æ£€æŸ¥ç¢° (åªæ£€æŸ¥ä¸‹å®¶? ä¸ï¼Œç¢°æ˜¯ä»»æ„å®¶)
            // ç®€åŒ–ï¼šåªæ£€æŸ¥ç©å®¶æ˜¯å¦èƒ½ç¢°
            if (!players[0].hasHu && fromIdx !== 0) {
                let count = 0;
                players[0].hand.forEach(t => { if(t.suit === tile.suit && t.value === tile.value) count++; });
                if (count >= 2) {
                    // ç©å®¶å¯ä»¥ç¢°
                    showPengPrompt(tile);
                    return;
                }
            }

            // å¦‚æœæ²¡äººèƒ¡ä¹Ÿæ²¡äººç¢°ï¼Œè½®åˆ°ä¸‹å®¶
            nextTurn();
        }

        function showHuPrompt(tile, huList) {
            const actionPanel = document.getElementById('action-panel');
            actionPanel.innerHTML = '';
            addActionButton('èƒ¡', 'btn-hu', () => {
                performHu(0, tile, false);
                // å¤„ç†å…¶ä»–æœºå™¨äººèƒ¡
                huList.filter(id => id !== 0).forEach(id => performHu(id, tile, false));
                actionPanel.style.display = 'none';
                nextTurn();
            });
            addActionButton('è¿‡', 'btn-pass', () => {
                 // å¤„ç†å…¶ä»–æœºå™¨äººèƒ¡
                huList.filter(id => id !== 0).forEach(id => performHu(id, tile, false));
                actionPanel.style.display = 'none';
                nextTurn();
            });
            actionPanel.style.display = 'flex';
        }

        function showPengPrompt(tile) {
             const actionPanel = document.getElementById('action-panel');
             actionPanel.innerHTML = '';
             addActionButton('ç¢°', 'btn-peng', () => {
                 performPeng(0, tile);
                 actionPanel.style.display = 'none';
                 enableHandClick(); // ç¢°å®Œè¦å‡ºç‰Œ
             });
             addActionButton('è¿‡', 'btn-pass', () => {
                 actionPanel.style.display = 'none';
                 nextTurn();
             });
             actionPanel.style.display = 'flex';
        }

        function performHu(pIdx, tile, isZimo) {
            players[pIdx].hasHu = true;
            if (!isZimo) players[pIdx].hand.push(tile); // ç‚¹ç‚®è¦æŠŠç‰Œæ‹¿è¿›æ¥å±•ç¤º
            sortHand(players[pIdx].hand);
            
            // è§†è§‰æ•ˆæœ
            document.getElementById(`hu-${pIdx}`).style.display = 'block';
            showHuAnim(pIdx);
            updateUI();
            
            winners.push(pIdx);
        }
        
        function performPeng(pIdx, tile) {
            const p = players[pIdx];
            // ç§»é™¤æ‰‹ç‰Œé‡Œçš„ä¸¤å¼ 
            let removed = 0;
            for(let i=p.hand.length-1; i>=0; i--){
                if(p.hand[i].suit === tile.suit && p.hand[i].value === tile.value) {
                    p.hand.splice(i, 1);
                    removed++;
                    if(removed===2) break;
                }
            }
            // åŠ å…¥ç¢°ç‰ŒåŒº
            p.peng.push(tile); 
            turnIndex = pIdx; // æŠ¢å¾—å›åˆ
            updateUI();
        }

        function enableHandClick() {
            const handDiv = document.getElementById('hand-0');
            const tiles = handDiv.getElementsByClassName('tile');
            const p = players[0];

            for (let i = 0; i < tiles.length; i++) {
                // è§„åˆ™ï¼šå¦‚æœæœ‰å®šç¼ºç‰Œï¼Œå¿…é¡»å…ˆå‡ºå®šç¼ºç‰Œ
                const t = p.hand[i];
                let hasQue = p.hand.some(x => x.suit === p.que);
                
                if (hasQue && t.suit !== p.que) {
                    tiles[i].classList.add('disabled');
                    tiles[i].onclick = null;
                } else {
                    tiles[i].classList.remove('disabled');
                    tiles[i].onclick = () => {
                        // ç§»é™¤äº‹ä»¶
                        for(let el of tiles) el.onclick = null;
                        discardTile(0, i);
                    };
                }
            }
        }

        // --- æœºå™¨äºº AI ---

        function botPlay(pIdx, newTile) {
            const p = players[pIdx];
            
            // 1. èƒ½èƒ¡å°±èƒ¡
            if (canHu(p.hand, p.que)) {
                performHu(pIdx, newTile, true);
                nextTurn();
                return;
            }

            // 2. å‡ºç‰Œé€»è¾‘
            // ä¼˜å…ˆå‡ºå®šç¼ºç‰Œ
            let discardIdx = -1;
            
            // æ‰¾å®šç¼ºç‰Œ
            for (let i = 0; i < p.hand.length; i++) {
                if (p.hand[i].suit === p.que) {
                    discardIdx = i;
                    break;
                }
            }

            // æ²¡æœ‰å®šç¼ºç‰Œï¼Œéšæœºå‡ºä¸€å¼ éå¯¹å­ã€éåˆ»å­çš„å­¤å¼  (ç®€åŒ–ä¸ºéšæœºå‡º)
            if (discardIdx === -1) {
                discardIdx = Math.floor(Math.random() * p.hand.length);
                // ç¨å¾®èªæ˜ä¸€ç‚¹ï¼šå°½é‡ä¸æ‹†å¯¹å­
                // è¿™é‡Œç®€åŒ–demoï¼Œç›´æ¥éšæœº
            }

            discardTile(pIdx, discardIdx);
        }

        // --- UI æ¸²æŸ“ ---

        function updateUI() {
            document.getElementById('wall-count').innerText = wall.length;
            
            // æ¸²æŸ“æ‰‹ç‰Œ
            for (let i = 0; i < 4; i++) {
                renderHand(i);
                renderDiscard(i);
            }
        }

        function renderHand(pIdx) {
            const el = document.getElementById(`hand-${pIdx}`);
            el.innerHTML = '';
            
            const p = players[pIdx];

            // æ¸²æŸ“ç¢°/æ çš„ç‰Œ
            p.peng.forEach(t => {
                // ç¢°æ˜¾ç¤º3å¼ 
                for(let k=0; k<3; k++) el.appendChild(createTileEl(t, 'ground'));
            });

            // æ¸²æŸ“æ‰‹ç‰Œ
            p.hand.forEach((t, index) => {
                // å¦‚æœä¸æ˜¯ç©å®¶è‡ªå·±ï¼Œä¸”æ²¡èƒ¡ï¼Œæ˜¾ç¤ºèƒŒé¢
                let type = 'normal';
                if (pIdx !== 0 && !p.hasHu) {
                    type = 'back';
                }
                
                const tileEl = createTileEl(t, type);
                // å¦‚æœæ˜¯æ–°æ‘¸çš„ç‰Œ (æœ€åä¸€å¼ ä¸”åˆšæ‘¸ç‰Œé˜¶æ®µ)
                // ç®€åŒ–å¤„ç†ï¼šä¸åŠ ç‰¹åˆ«çš„marginï¼Œé™¤é...
                el.appendChild(tileEl);
            });
        }

        function renderDiscard(pIdx) {
            const el = document.getElementById(`disc-${pIdx}`);
            el.innerHTML = '';
            players[pIdx].discards.forEach(t => {
                el.appendChild(createTileEl(t, 'ground'));
            });
        }

        function createTileEl(tile, type = 'normal') { // normal, back, ground
            const div = document.createElement('div');
            div.className = `tile ${type}`;
            if (type !== 'back') {
                div.innerHTML = `<div class="tile-inner suit-${tile.suit}">${tile.char}</div>`;
            } else {
                div.innerHTML = `<div class="tile-inner"></div>`;
            }
            return div;
        }

        function updateWallCount() {
             const el = document.getElementById('turn-indicator');
             const dirs = ['å—(æˆ‘)', 'ä¸œ(ä¸‹)', 'åŒ—(å¯¹)', 'è¥¿(ä¸Š)'];
             el.innerText = "å½“å‰: " + dirs[turnIndex];
        }

        function addActionButton(text, cls, callback) {
            const btn = document.createElement('div');
            btn.className = `btn ${cls}`;
            btn.innerText = text;
            btn.onclick = callback;
            document.getElementById('action-panel').appendChild(btn);
        }

        function showHuAnim(pIdx) {
            const el = document.getElementById('hu-effect');
            // ç®€å•çš„ä½ç½®è°ƒæ•´
            el.style.top = '50%';
            el.style.left = '50%';
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 1500);
        }

        function endGame() {
            alert("æœ¬å±€ç»“æŸ! èƒ¡ç‰Œç©å®¶: " + (winners.length > 0 ? winners.map(i => i===0?"æˆ‘":`Bot${i}`) : "æ—  (æµå±€)"));
            location.reload();
        }

        // å¯åŠ¨
        initGame();

    </script>
</body>
</html>