<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lecteur Magique Pro ğŸŒŸ</title>
    <style>
        :root {
            --bg-paper: #fdfbf7;
            --text-ink: #2c3e50;
            --highlight: #fffacd; /* æ­£åœ¨æœ—è¯»çš„å¥å­é«˜äº® */
            --sentence-hover: #eef2f3; /* é¼ æ ‡/æ‰‹æŒ‡æ‚¬åœå¥å­é¢œè‰² */
            --accent: #ff85a2;
            --accent-blue: #4facfe;
            --word-highlight: #ffeb3b; /* æŸ¥è¯æ—¶çš„é«˜äº® */
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- é¡¶éƒ¨æ§åˆ¶æ  --- */
        .navbar {
            width: 100%;
            background: white;
            padding: 10px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .nav-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* è¯­è¨€åˆ‡æ¢å¼€å…³ */
        .lang-switch {
            display: flex;
            background: #f0f0f0;
            border-radius: 20px;
            padding: 2px;
            cursor: pointer;
        }
        .lang-opt {
            padding: 5px 12px;
            border-radius: 18px;
            font-size: 1.2rem;
            opacity: 0.5;
            transition: 0.3s;
        }
        .lang-opt.active {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            opacity: 1;
            font-weight: bold;
        }

        /* ä¸‹æ‹‰é€‰ä¹¦ */
        select#book-select {
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 1rem;
            max-width: 150px;
        }

        /* å¯¼å…¥æŒ‰é’® */
        .file-btn {
            background: var(--accent-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* --- é˜…è¯»åŒºåŸŸ --- */
        .reader-container {
            flex: 1;
            width: 100%;
            max-width: 800px;
            background-color: var(--bg-paper);
            overflow-y: auto;
            padding: 40px 30px;
            box-sizing: border-box;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            -webkit-overflow-scrolling: touch;
        }

        #content-area {
            font-family: 'Georgia', serif;
            font-size: 1.5rem;
            line-height: 1.8;
            color: var(--text-ink);
            text-align: justify;
        }

        /* å¥å­å’Œå•è¯æ ·å¼ */
        .sentence {
            border-radius: 5px;
            padding: 2px 0;
            transition: background 0.2s;
            cursor: pointer;
        }
        .sentence:hover {
            background-color: var(--sentence-hover);
        }
        .sentence.reading {
            background-color: var(--highlight);
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        }

        .word {
            display: inline-block;
            border-radius: 3px;
            padding: 0 1px;
        }
        .word:active {
            background-color: var(--accent);
            color: white;
        }
        .word.selected {
            background-color: var(--word-highlight);
            text-decoration: underline;
        }

        /* --- åº•éƒ¨æ’­æ”¾æ  --- */
        .controls {
            width: 100%;
            background: white;
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
            border-top: 1px solid #ddd;
            box-sizing: border-box;
        }
        
        .ctrl-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: 2px solid #eee;
            background: white;
            font-size: 24px;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .ctrl-btn:active { transform: scale(0.95); }

        /* --- å•è¯å¼¹çª— --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .word-card {
            background: white;
            width: 300px;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }
        .wc-word { font-size: 2rem; font-weight: bold; color: var(--accent); margin-bottom: 10px; }
        .wc-trans { font-size: 1.2rem; color: #555; margin-bottom: 20px; min-height: 1.5em;}

        /* éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† */
        #file-input { display: none; }

    </style>
</head>
<body>

    <div class="navbar">
        <div class="nav-group">
            <div class="lang-switch">
                <div class="lang-opt active" id="lang-en" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ English</div>
                <div class="lang-opt" id="lang-fr" onclick="setLang('fr')">ğŸ‡«ğŸ‡· FranÃ§ais</div>
            </div>
        </div>

        <div class="nav-group">
            <select id="book-select" onchange="loadSelectedBook()">
                <option value="story1">Little Red Riding Hood (EN)</option>
                <option value="story2">The Three Little Pigs (EN)</option>
                <option value="story_fr1">Le Petit Prince (Extrait) (FR)</option>
            </select>
            
            <label for="file-input" class="file-btn">
                ğŸ“‚ Ouvrir
            </label>
            <input type="file" id="file-input" accept=".txt" onchange="handleFileUpload(event)">
        </div>
    </div>

    <div class="reader-container">
        <div id="content-area"></div>
    </div>

    <div class="controls">
        <button class="ctrl-btn" onclick="changeSpeed(0.8)">ğŸ¢</button>
        <button class="ctrl-btn" onclick="playAll()" id="play-btn" style="border-color:var(--accent); color:var(--accent)">â–¶ï¸</button>
        <button class="ctrl-btn" onclick="changeSpeed(1.2)">ğŸ‡</button>
    </div>

    <div class="modal-overlay" id="modal" onclick="closeModal(event)">
        <div class="word-card" onclick="event.stopPropagation()">
            <div style="position:absolute; top:10px; right:15px; font-size:24px; color:#ccc; cursor:pointer" onclick="closeModal()">Ã—</div>
            <div class="wc-word" id="modal-word">Word</div>
            <div class="wc-trans" id="modal-action">
                </div>
            <div style="display:flex; justify-content:center; gap:15px">
                <button class="ctrl-btn" onclick="speakSelectedWord()" style="background:#f0f0f0">ğŸ”Š</button>
                <button class="ctrl-btn" onclick="openTranslation()" style="background:#e0f7fa">ğŸŒ Traduction</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. é¢„ç½®å›¾ä¹¦æ•°æ® ---
        const library = {
            story1: `Once upon a time, there was a little girl named Little Red Riding Hood. She loved her grandmother very much. One day, her mother said, "Here is a cake for grandmother. Do not stop in the forest." But the little girl met a big bad wolf.`,
            story2: `Once upon a time, there were three little pigs. The first pig built a house of straw. The second pig built a house of sticks. The third pig built a house of bricks. The big bad wolf came and huffed and puffed.`,
            story_fr1: `Lorsque j'avais six ans j'ai vu, une fois, une magnifique image, dans un livre sur la ForÃªt Vierge qui s'appelait "Histoires VÃ©cues". Ã‡a reprÃ©sentait un serpent boa qui avalait un fauve. VoilÃ  la copie du dessin.`
        };

        // --- 2. å…¨å±€çŠ¶æ€ ---
        let currentLang = 'en'; // 'en' or 'fr'
        let speechRate = 1.0;
        let currentText = "";
        let selectedWord = "";
        let synth = window.speechSynthesis;
        let currentUtterance = null;

        // --- 3. åˆå§‹åŒ– ---
        window.onload = function() {
            loadSelectedBook();
        };

        function setLang(lang) {
            currentLang = lang;
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            document.getElementById('lang-fr').classList.toggle('active', lang === 'fr');
            
            // åœæ­¢æœ—è¯»ï¼Œå› ä¸ºè¯­éŸ³åŒ…å˜äº†
            stopSpeaking();
        }

        // --- 4. å›¾ä¹¦åŠ è½½ä¸è§£æ ---
        function loadSelectedBook() {
            const key = document.getElementById('book-select').value;
            // è‡ªåŠ¨åˆ¤æ–­è¯­è¨€
            if(key.includes('fr')) setLang('fr');
            else setLang('en');
            
            renderText(library[key]);
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                // ç®€å•çŒœæµ‹è¯­è¨€ï¼šå¦‚æœæœ‰ "the" å¯èƒ½æ˜¯è‹±æ–‡ï¼Œæœ‰ "le/la" å¯èƒ½æ˜¯æ³•æ–‡
                // è¿™é‡Œä¸åšå¤æ‚æ£€æµ‹ï¼Œé»˜è®¤ä¿æŒå½“å‰ï¼Œæˆ–è€…è®©ç”¨æˆ·è‡ªå·±åˆ‡
                renderText(text);
                // é‡ç½®ä¸‹æ‹‰æ¡†
                document.getElementById('book-select').value = ""; 
            };
            reader.readAsText(file);
        }

        // æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ï¼šåˆ†æ®µ -> åˆ†å¥ -> åˆ†è¯
        function renderText(text) {
            currentText = text;
            stopSpeaking();
            const container = document.getElementById('content-area');
            container.innerHTML = '';

            // 1. åˆ†æ®µ (æŒ‰æ¢è¡Œ)
            const paragraphs = text.split(/\n+/);

            paragraphs.forEach(para => {
                if(!para.trim()) return;
                const pDiv = document.createElement('div');
                pDiv.style.marginBottom = '20px';

                // 2. åˆ†å¥ (æ­£åˆ™åŒ¹é… . ! ? ä½†ä¿ç•™ç¬¦å·)
                // è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„æ­£åˆ™ï¼Œç”¨äºå°½é‡å‡†ç¡®åˆ‡åˆ†å¥å­
                const sentences = para.match(/[^.!?]+[.!?]+["']?|[^.!?]+$/g);

                if(sentences) {
                    sentences.forEach(sentText => {
                        const spanSent = document.createElement('span');
                        spanSent.className = 'sentence';
                        spanSent.onclick = (e) => playSentence(sentText, spanSent, e);
                        
                        // 3. åˆ†è¯ (ä¸ºäº†ç‚¹å‡»å•è¯)
                        // å°†å¥å­æ‹†æˆ å•è¯ å’Œ éå•è¯(æ ‡ç‚¹ç©ºæ ¼)
                        const tokens = sentText.split(/([a-zA-ZÃ -Ã¼Ã€-Ãœ0-9]+)/g);
                        
                        tokens.forEach(token => {
                            if(token.match(/[a-zA-ZÃ -Ã¼Ã€-Ãœ0-9]+/)) {
                                const spanWord = document.createElement('span');
                                spanWord.className = 'word';
                                spanWord.innerText = token;
                                spanWord.onclick = (e) => handleWordClick(token, e);
                                spanSent.appendChild(spanWord);
                            } else {
                                spanSent.appendChild(document.createTextNode(token));
                            }
                        });

                        pDiv.appendChild(spanSent);
                        // åŠ ä¸ªç©ºæ ¼é˜²æ­¢å¥å­ç²˜è¿
                        pDiv.appendChild(document.createTextNode(' ')); 
                    });
                }
                container.appendChild(pDiv);
            });
        }

        // --- 5. äº¤äº’åŠŸèƒ½ ---

        // ç‚¹å‡»å•è¯
        function handleWordClick(word, event) {
            event.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¥è¯»
            stopSpeaking(); // åœæ­¢æ­£åœ¨è¯»çš„å¥å­

            selectedWord = word;
            document.getElementById('modal-word').innerText = word;
            
            // æ ¹æ®å½“å‰ä¹¦çš„è¯­è¨€æç¤º
            const actionText = currentLang === 'en' 
                ? "Mot anglais ğŸ‡¬ğŸ‡§" 
                : "Mot franÃ§ais ğŸ‡«ğŸ‡·";
            document.getElementById('modal-action').innerText = actionText;

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('modal').style.display = 'flex';
            
            // è‡ªåŠ¨æœ—è¯»å•è¯
            speakText(word, currentLang === 'en' ? 'en-US' : 'fr-FR');
        }

        function closeModal(e) {
            if(e && e.target !== document.getElementById('modal') && e.target.innerText !== 'Ã—') return;
            document.getElementById('modal').style.display = 'none';
        }

        // æœ—è¯»å¥å­
        function playSentence(text, element, event) {
            // è§†è§‰é«˜äº®
            document.querySelectorAll('.sentence').forEach(el => el.classList.remove('reading'));
            element.classList.add('reading');

            speakText(text, currentLang === 'en' ? 'en-US' : 'fr-FR', () => {
                element.classList.remove('reading');
            });
        }

        // å…¨æ–‡æœ—è¯»
        function playAll() {
            if(synth.speaking) {
                stopSpeaking();
                return;
            }
            document.getElementById('play-btn').innerText = "â¹ï¸";
            // è¿™é‡Œç®€å•å¤„ç†ï¼Œç›´æ¥è¯»æ•´æ®µæ–‡æœ¬ã€‚
            // å¦‚æœæƒ³å®ç°å¥å­é€ä¸ªé«˜äº®ï¼Œé€»è¾‘ä¼šå¤æ‚å¾ˆå¤šï¼Œè€ƒè™‘åˆ°å­©å­ä½¿ç”¨ï¼Œ
            // å»ºè®®ä¸»è¦ç”¨â€œç‚¹è¯»å¥å­â€åŠŸèƒ½ï¼Œè¿™é‡Œä½œä¸ºå¤‡ç”¨ã€‚
            speakText(currentText, currentLang === 'en' ? 'en-US' : 'fr-FR', () => {
                document.getElementById('play-btn').innerText = "â–¶ï¸";
            });
        }

        // --- 6. è¯­éŸ³åˆæˆæ ¸å¿ƒ ---
        function speakText(text, langCode, onEndCallback) {
            stopSpeaking();
            
            const u = new SpeechSynthesisUtterance(text);
            u.lang = langCode;
            u.rate = speechRate;
            
            // å°è¯•è·å–æ›´å¥½çš„è¯­éŸ³ (iOS Safari é€šå¸¸ä¼šè‡ªåŠ¨å¤„ç†ï¼Œä½†åŠ ä¸Šè¿™æ­¥æ›´ä¿é™©)
            // æ³¨æ„ï¼šgetVoicesæ˜¯å¼‚æ­¥çš„ï¼Œä½†åœ¨iPad Safariä¸Šé€šå¸¸ä¸éœ€è¦ç­‰å¾…
            const voices = synth.getVoices();
            // ä¼˜å…ˆæ‰¾ Lang åŒ¹é…çš„ voice
            const targetVoice = voices.find(v => v.lang.includes(langCode));
            if(targetVoice) u.voice = targetVoice;

            u.onend = function() {
                if(onEndCallback) onEndCallback();
            };

            synth.speak(u);
        }

        function speakSelectedWord() {
            speakText(selectedWord, currentLang === 'en' ? 'en-US' : 'fr-FR');
        }

        function stopSpeaking() {
            synth.cancel();
            document.querySelectorAll('.sentence').forEach(el => el.classList.remove('reading'));
            document.getElementById('play-btn').innerText = "â–¶ï¸";
        }

        function changeSpeed(rate) {
            speechRate = rate;
            // ç®€å•çš„åé¦ˆåŠ¨ç”»
            event.target.style.transform = "scale(1.2)";
            setTimeout(() => event.target.style.transform = "scale(1)", 200);
        }

        // --- 7. ç¿»è¯‘è·³è½¬ ---
        function openTranslation() {
            // åŠ¨æ€ç”Ÿæˆ Google ç¿»è¯‘é“¾æ¥
            let src = currentLang;
            let target = currentLang === 'en' ? 'fr' : 'en'; // å¦‚æœæ˜¯è‹±æ–‡ä¹¦è¯‘æˆæ³•æ–‡ï¼Œæ³•æ–‡ä¹¦è¯‘æˆè‹±æ–‡
            const url = `https://translate.google.com/?sl=${src}&tl=${target}&text=${encodeURIComponent(selectedWord)}&op=translate`;
            window.open(url, '_blank');
        }

    </script>
</body>
</html>