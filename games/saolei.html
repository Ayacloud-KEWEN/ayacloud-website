<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»å…¸æ‰«é›· Webç‰ˆ</title>
    <style>
        :root {
            --win-gray: #c0c0c0;
            --win-light: #ffffff;
            --win-dark: #808080;
            --win-black: #000000;
            --digit-red: #ff0000;
            --bg-color: #008080; /* ç»å…¸çš„è“ç»¿è‰²æ¡Œé¢èƒŒæ™¯ */
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Tahoma', 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            user-select: none;
            touch-action: manipulation;
        }

        /* ç»å…¸ Windows çª—å£å¤–æ¡† */
        .window-frame {
            background-color: var(--win-gray);
            border-top: 3px solid var(--win-light);
            border-left: 3px solid var(--win-light);
            border-right: 3px solid var(--win-dark);
            border-bottom: 3px solid var(--win-dark);
            padding: 6px;
            display: inline-block;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ  (å‡¹é™·æ•ˆæœ) */
        .header {
            border-top: 2px solid var(--win-dark);
            border-left: 2px solid var(--win-dark);
            border-right: 2px solid var(--win-light);
            border-bottom: 2px solid var(--win-light);
            margin-bottom: 6px;
            padding: 4px 7px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* æ•°ç ç®¡æ˜¾ç¤ºåŒºåŸŸ */
        .digit-box {
            background-color: black;
            color: var(--digit-red);
            font-family: "Courier New", Courier, monospace;
            font-size: 26px;
            font-weight: bold;
            line-height: 26px;
            padding: 1px 2px;
            border-top: 1px solid var(--win-dark);
            border-left: 1px solid var(--win-dark);
            border-bottom: 1px solid var(--win-light);
            border-right: 1px solid var(--win-light);
            min-width: 46px;
            text-align: right;
            letter-spacing: 1px;
        }

        /* ç¬‘è„¸æŒ‰é’® */
        .face-btn {
            width: 36px;
            height: 36px;
            border-top: 2px solid var(--win-light);
            border-left: 2px solid var(--win-light);
            border-right: 2px solid var(--win-dark);
            border-bottom: 2px solid var(--win-dark);
            background-color: var(--win-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }
        .face-btn:active {
            border-top: 2px solid var(--win-dark);
            border-left: 2px solid var(--win-dark);
            border-right: 2px solid var(--win-light);
            border-bottom: 2px solid var(--win-light);
            padding-top: 2px; /* æ¨¡æ‹ŸæŒ‰ä¸‹ä½ç§» */
            padding-left: 2px;
        }

        /* æ£‹ç›˜åŒºåŸŸ (å‡¹é™·æ•ˆæœ) */
        .board-container {
            border-top: 3px solid var(--win-dark);
            border-left: 3px solid var(--win-dark);
            border-right: 3px solid var(--win-light);
            border-bottom: 3px solid var(--win-light);
            position: relative;
            overflow: auto; /* å¦‚æœå±å¹•å¤ªå°æ”¯æŒæ»šåŠ¨ */
        }

        .grid {
            display: grid;
            background-color: var(--win-dark); /* ç¼éš™é¢œè‰² */
        }

        /* å•ä¸ªæ ¼å­ */
        .cell {
            width: 30px;
            height: 30px;
            background-color: var(--win-gray);
            border-top: 2px solid var(--win-light);
            border-left: 2px solid var(--win-light);
            border-right: 2px solid var(--win-dark);
            border-bottom: 2px solid var(--win-dark);
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 18px;
            cursor: pointer;
        }

        /* è¢«æŒ‰ä¸‹çš„æ ¼å­ / å·²æ‰“å¼€çš„æ ¼å­ */
        .cell.open {
            border: 1px solid #999; /* æç»†çš„è¾¹æ¡† */
            border-top: none; 
            border-left: none;
            background-color: var(--win-gray);
            width: 30px; height: 30px; /* ç¡®ä¿å°ºå¯¸ä¸å˜ */
        }
        
        /* è¿˜æ²¡æ‰“å¼€ä½†é¼ æ ‡æŒ‰ä¸‹çš„çŠ¶æ€ */
        .cell:active:not(.open):not(.flagged) {
            border: none;
            border-top: 1px solid var(--win-dark);
            border-left: 1px solid var(--win-dark);
        }

        /* æ•°å­—é¢œè‰² */
        .c1 { color: blue; }
        .c2 { color: green; }
        .c3 { color: red; }
        .c4 { color: navy; }
        .c5 { color: maroon; }
        .c6 { color: teal; }
        .c7 { color: black; }
        .c8 { color: gray; }

        .cell.mine { background-color: var(--win-gray); }
        .cell.exploded { background-color: red; }
        .cell.flagged { color: red; }

        /* åº•éƒ¨æ‰‹æœºæ§åˆ¶æ  */
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .mode-toggle {
            width: 140px;
            height: 44px;
            border-radius: 22px;
            background-color: #fff;
            display: flex;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            cursor: pointer;
            overflow: hidden;
        }
        
        .toggle-bg {
            position: absolute;
            top: 2px; left: 2px;
            width: 50%;
            height: 40px;
            background-color: #007bff;
            border-radius: 20px;
            transition: transform 0.2s;
        }
        
        .mode-opt {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            font-size: 1.2rem;
            transition: color 0.2s;
        }
        
        .mode-toggle[data-mode="dig"] .toggle-bg { transform: translateX(0); }
        .mode-toggle[data-mode="dig"] .mode-dig { color: white; }
        .mode-toggle[data-mode="dig"] .mode-flag { color: #ccc; }

        .mode-toggle[data-mode="flag"] .toggle-bg { transform: translateX(100%); background-color: #dc3545; }
        .mode-toggle[data-mode="flag"] .mode-dig { color: #ccc; }
        .mode-toggle[data-mode="flag"] .mode-flag { color: white; }

        /* éš¾åº¦é€‰æ‹© */
        select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #fff;
            background: rgba(255,255,255,0.9);
            font-weight: bold;
        }

    </style>
</head>
<body>

    <div class="window-frame">
        <div class="header">
            <div class="digit-box" id="mine-count">010</div>
            <div class="face-btn" id="face-btn" onclick="resetGame()">ğŸ™‚</div>
            <div class="digit-box" id="timer">000</div>
        </div>

        <div class="board-container">
            <div id="grid" class="grid"></div>
        </div>
    </div>

    <div class="controls">
        <select id="difficulty" onchange="changeDifficulty()">
            <option value="beginner">åˆçº§ (9x9)</option>
            <option value="intermediate">ä¸­çº§ (16x16)</option>
            <option value="expert">é«˜çº§ (16x30)</option>
        </select>
        
        <div class="mode-toggle" id="mode-switch" data-mode="dig" onclick="toggleMode()">
            <div class="toggle-bg"></div>
            <div class="mode-opt mode-dig">â›ï¸</div>
            <div class="mode-opt mode-flag">ğŸš©</div>
        </div>
    </div>

    <script>
        const gridEl = document.getElementById('grid');
        const mineCountEl = document.getElementById('mine-count');
        const timerEl = document.getElementById('timer');
        const faceBtn = document.getElementById('face-btn');
        const modeSwitch = document.getElementById('mode-switch');
        const diffSelect = document.getElementById('difficulty');

        // é…ç½®
        const LEVELS = {
            beginner: { rows: 9, cols: 9, mines: 10 },
            intermediate: { rows: 16, cols: 16, mines: 40 },
            expert: { rows: 30, cols: 16, mines: 99 } // ç«–å±é€‚é…ï¼š30è¡Œ16åˆ—
        };

        let config = LEVELS.beginner;
        let board = []; // å­˜æ•°æ®
        let firstClick = true;
        let isGameOver = false;
        let flagsUsed = 0;
        let timeElapsed = 0;
        let timerInterval = null;
        let currentMode = 'dig'; // 'dig' or 'flag'

        // éŸ³æ•ˆï¼ˆå¯é€‰ï¼Œè¿™é‡Œæš‚æ—¶é™éŸ³ï¼Œè§†è§‰åé¦ˆè¶³å¤Ÿï¼‰
        
        function initGame() {
            // åœæ­¢è®¡æ—¶å™¨
            clearInterval(timerInterval);
            timerInterval = null;
            timeElapsed = 0;
            timerEl.innerText = '000';

            // é‡ç½®çŠ¶æ€
            firstClick = true;
            isGameOver = false;
            flagsUsed = 0;
            faceBtn.innerText = 'ğŸ™‚';
            
            // è·å–å½“å‰éš¾åº¦é…ç½®
            // å¦‚æœæ˜¯expertï¼Œè°ƒæ•´è¡Œåˆ—ä»¥é€‚åº”ç«–å±æ‰‹æœº
            let levelKey = diffSelect.value;
            config = LEVELS[levelKey];
            
            updateMineCounter();

            // ç”Ÿæˆç½‘æ ¼HTML
            gridEl.style.gridTemplateColumns = `repeat(${config.cols}, 30px)`;
            gridEl.style.gridTemplateRows = `repeat(${config.rows}, 30px)`;
            gridEl.innerHTML = '';

            board = [];
            for(let y = 0; y < config.rows; y++) {
                let row = [];
                for(let x = 0; x < config.cols; x++) {
                    let cellData = {
                        x, y,
                        isMine: false,
                        isOpen: false,
                        isFlagged: false,
                        count: 0
                    };
                    row.push(cellData);

                    let cellEl = document.createElement('div');
                    cellEl.className = 'cell';
                    cellEl.dataset.x = x;
                    cellEl.dataset.y = y;
                    
                    // ç»‘å®šäº‹ä»¶
                    // 1. é¼ æ ‡/è§¦æ‘¸æŒ‰ä¸‹ï¼šè¡¨æƒ…å˜æƒŠè®¶
                    cellEl.addEventListener('mousedown', () => {
                        if(!isGameOver) faceBtn.innerText = 'ğŸ˜®';
                    });
                    cellEl.addEventListener('touchstart', () => {
                        if(!isGameOver) faceBtn.innerText = 'ğŸ˜®';
                    });

                    // 2. é¼ æ ‡æŠ¬èµ·/è§¦æ‘¸ç»“æŸï¼šè¡¨æƒ…æ¢å¤
                    document.addEventListener('mouseup', () => {
                        if(!isGameOver && faceBtn.innerText === 'ğŸ˜®') faceBtn.innerText = 'ğŸ™‚';
                    });
                    document.addEventListener('touchend', () => {
                        if(!isGameOver && faceBtn.innerText === 'ğŸ˜®') faceBtn.innerText = 'ğŸ™‚';
                    });

                    // 3. ç‚¹å‡»å¤„ç† (åŒ…å«å·¦é”®å’Œè§¦æ‘¸)
                    cellEl.addEventListener('click', (e) => handleInteraction(x, y, 'click'));
                    
                    // 4. å³é”®å¤„ç† (ç”µè„‘ç«¯æ’æ——)
                    cellEl.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleInteraction(x, y, 'rightclick');
                    });

                    // 5. æ‰‹æœºé•¿æŒ‰å¤„ç†
                    let pressTimer;
                    cellEl.addEventListener('touchstart', (e) => {
                        if(isGameOver) return;
                        pressTimer = setTimeout(() => {
                            handleInteraction(x, y, 'rightclick'); // é•¿æŒ‰è§†ä¸ºå³é”®
                        }, 500); // 500ms é•¿æŒ‰
                    }, {passive: true});
                    cellEl.addEventListener('touchend', () => clearTimeout(pressTimer));
                    cellEl.addEventListener('touchmove', () => clearTimeout(pressTimer));

                    cellData.el = cellEl;
                    gridEl.appendChild(cellEl);
                }
                board.push(row);
            }
        }

        // æ ¸å¿ƒäº¤äº’é€»è¾‘
        function handleInteraction(x, y, type) {
            if(isGameOver) return;

            const cell = board[y][x];

            // é€»è¾‘åˆ¤æ–­ï¼šæ˜¯æŒ–æ˜è¿˜æ˜¯æ’æ——
            let action = '';
            
            if (type === 'rightclick') {
                action = 'flag';
            } else {
                // æ™®é€šç‚¹å‡»ï¼Œå–å†³äºå½“å‰æ¨¡å¼å¼€å…³
                if (currentMode === 'flag') {
                    action = 'flag';
                } else {
                    action = 'dig';
                }
            }

            if (action === 'flag') {
                toggleFlag(cell);
            } else {
                if (cell.isFlagged) return; // æ——å­ä¿æŠ¤
                if (cell.isOpen) {
                    // å¿«æ·æ“ä½œï¼šç‚¹å¼€å·²æ‰“å¼€çš„æ•°å­—ï¼Œå¦‚æœå‘¨å›´æ——å­æ•°å¤Ÿäº†ï¼Œè‡ªåŠ¨å¼€å‘¨å›´
                    chord(cell);
                } else {
                    openCell(cell);
                }
            }
        }

        // ç”Ÿæˆåœ°é›· (ä¿è¯ç¬¬ä¸€ä¸‹ä¸ç‚¸)
        function placeMines(safeX, safeY) {
            let minesPlaced = 0;
            while(minesPlaced < config.mines) {
                let rx = Math.floor(Math.random() * config.cols);
                let ry = Math.floor(Math.random() * config.rows);
                
                // ä¸åœ¨å·²æœ‰ç‚¹é›·ã€ä¸åœ¨èµ·ç‚¹ã€ä¹Ÿä¸åœ¨èµ·ç‚¹å‘¨å›´(å¯é€‰ï¼Œç®€å•èµ·è§åªé¿å¼€èµ·ç‚¹)
                if (!board[ry][rx].isMine && (rx !== safeX || ry !== safeY)) {
                    board[ry][rx].isMine = true;
                    minesPlaced++;
                }
            }
            // è®¡ç®—æ•°å­—
            for(let y=0; y<config.rows; y++){
                for(let x=0; x<config.cols; x++){
                    if(!board[y][x].isMine) {
                        board[y][x].count = countNeighbors(x, y);
                    }
                }
            }
        }

        function countNeighbors(x, y) {
            let count = 0;
            for(let dy=-1; dy<=1; dy++){
                for(let dx=-1; dx<=1; dx++){
                    let nx = x + dx, ny = y + dy;
                    if(nx >= 0 && nx < config.cols && ny >= 0 && ny < config.rows) {
                        if(board[ny][nx].isMine) count++;
                    }
                }
            }
            return count;
        }

        function openCell(cell) {
            if(cell.isOpen || cell.isFlagged) return;

            // ç¬¬ä¸€æ¬¡ç‚¹å‡»
            if(firstClick) {
                firstClick = false;
                placeMines(cell.x, cell.y);
                startTimer();
                
                // å¦‚æœç”Ÿæˆåå½“å‰æ ¼ä¹Ÿæ˜¯æ•°å­—ï¼Œæ­£å¸¸æ‰“å¼€ï¼›å¦‚æœæ˜¯0ï¼Œé€’å½’
                // ç”±äº placeMines é€»è¾‘ä¿è¯å½“å‰ä¸æ˜¯é›·
            }

            cell.isOpen = true;
            cell.el.classList.add('open');
            
            if(cell.isMine) {
                gameOver(false, cell);
                return;
            }

            if(cell.count > 0) {
                cell.el.textContent = cell.count;
                cell.el.classList.add('c' + cell.count);
            } else {
                // 0ï¼Œç©ºåœ°ï¼Œæ´ªæ°´å¡«å……
                // cell.el.textContent = ''; 
                floodFill(cell.x, cell.y);
            }

            checkWin();
        }

        function floodFill(x, y) {
            for(let dy=-1; dy<=1; dy++){
                for(let dx=-1; dx<=1; dx++){
                    let nx = x + dx, ny = y + dy;
                    if(nx >= 0 && nx < config.cols && ny >= 0 && ny < config.rows) {
                        let neighbor = board[ny][nx];
                        if(!neighbor.isOpen && !neighbor.isFlagged) {
                            openCell(neighbor);
                        }
                    }
                }
            }
        }

        // "åŒå‡»"æ•ˆæœï¼šå¦‚æœå‘¨å›´æ——å­æ•°ç­‰äºæ•°å­—ï¼Œè‡ªåŠ¨ç‚¹å¼€å‘¨å›´æœªçŸ¥çš„
        function chord(cell) {
            if(cell.count === 0) return;
            
            let flagCount = 0;
            let neighbors = [];
            
            for(let dy=-1; dy<=1; dy++){
                for(let dx=-1; dx<=1; dx++){
                    let nx = cell.x + dx, ny = cell.y + dy;
                    if(nx >= 0 && nx < config.cols && ny >= 0 && ny < config.rows) {
                        if(nx===cell.x && ny===cell.y) continue;
                        neighbors.push(board[ny][nx]);
                        if(board[ny][nx].isFlagged) flagCount++;
                    }
                }
            }

            if(flagCount === cell.count) {
                neighbors.forEach(n => {
                    if(!n.isOpen && !n.isFlagged) openCell(n);
                });
            }
        }

        function toggleFlag(cell) {
            if(cell.isOpen) return;
            
            if(cell.isFlagged) {
                cell.isFlagged = false;
                cell.el.classList.remove('flagged');
                cell.el.textContent = '';
                flagsUsed--;
            } else {
                cell.isFlagged = true;
                cell.el.classList.add('flagged');
                cell.el.textContent = 'ğŸš©';
                flagsUsed++;
            }
            updateMineCounter();
        }

        function updateMineCounter() {
            let diff = config.mines - flagsUsed;
            // æ ¼å¼åŒ–ä¸º 010, -01 ç­‰
            let str = Math.abs(diff).toString().padStart(3, '0');
            if(diff < 0) str = '-' + str.substr(0,2);
            mineCountEl.innerText = str;
        }

        function startTimer() {
            if(timerInterval) return;
            let startTime = Date.now();
            timerInterval = setInterval(() => {
                timeElapsed = Math.floor((Date.now() - startTime) / 1000);
                if(timeElapsed > 999) timeElapsed = 999;
                timerEl.innerText = timeElapsed.toString().padStart(3, '0');
            }, 1000);
        }

        function gameOver(win, triggerCell) {
            isGameOver = true;
            clearInterval(timerInterval);
            
            if(win) {
                faceBtn.innerText = 'ğŸ˜';
                // æŠŠæ‰€æœ‰éé›·çš„æ ¼å­æ ‡è®°ä¸ºæ——å­ï¼ˆè§†è§‰ä¸Šï¼‰
                updateMineCounter();
            } else {
                faceBtn.innerText = 'ğŸ˜µ';
                if(triggerCell) {
                    triggerCell.el.classList.add('exploded');
                }
                // æ˜¾ç¤ºæ‰€æœ‰é›·
                board.forEach(row => row.forEach(cell => {
                    if(cell.isMine && !cell.isFlagged) {
                        cell.el.classList.add('mine');
                        cell.el.textContent = 'ğŸ’£';
                    }
                    // æ ‡é”™çš„é›·
                    if(!cell.isMine && cell.isFlagged) {
                        cell.el.textContent = 'âŒ';
                    }
                }));
            }
        }

        function checkWin() {
            let openCount = 0;
            board.forEach(row => row.forEach(cell => {
                if(cell.isOpen) openCount++;
            }));

            if(openCount === (config.rows * config.cols - config.mines)) {
                gameOver(true);
            }
        }

        // å¤–éƒ¨æ§åˆ¶
        function resetGame() {
            initGame();
        }

        function toggleMode() {
            if(currentMode === 'dig') {
                currentMode = 'flag';
            } else {
                currentMode = 'dig';
            }
            modeSwitch.setAttribute('data-mode', currentMode);
        }

        function changeDifficulty() {
            resetGame();
        }

        // ç¦æ­¢å³é”®èœå•
        document.addEventListener('contextmenu', event => event.preventDefault());

        // å¯åŠ¨
        initGame();

    </script>
</body>
</html>