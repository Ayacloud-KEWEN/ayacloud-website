<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦…æ„æ•°ç‹¬</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --board-bg: #ffffff;
            --text-main: #2c3e50;
            --text-user: #3498db; /* ç”¨æˆ·å¡«å†™çš„é¢œè‰² */
            --text-error: #e74c3c;
            --line-light: #e0e0e0;
            --line-heavy: #34495e;
            --highlight-cell: #e8f4f8;
            --highlight-same: #d6eaf8;
            --btn-color: #2c3e50;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            user-select: none;
        }

        /* é¡¶éƒ¨ */
        .header {
            width: 90%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: var(--text-main);
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .difficulty-select {
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid var(--line-heavy);
            background: transparent;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        /* æ£‹ç›˜åŒºåŸŸ */
        .board-wrapper {
            width: 94vw;
            max-width: 500px;
            aspect-ratio: 1/1;
            background: var(--board-bg);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            padding: 5px;
            box-sizing: border-box;
            position: relative;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 100%;
            height: 100%;
            border: 2px solid var(--line-heavy);
            box-sizing: border-box;
        }

        .cell {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4rem;
            border-right: 1px solid var(--line-light);
            border-bottom: 1px solid var(--line-light);
            cursor: pointer;
            color: var(--text-main);
            transition: background 0.1s;
            position: relative;
        }

        /* å³è¾¹æ¡†åŠ ç²— (æ¯3åˆ—) */
        .cell:nth-child(3n) {
            border-right: 2px solid var(--line-heavy);
        }
        /* æœ€åä¸€åˆ—å»æ‰å³è¾¹æ¡† (ç”±gridè¾¹æ¡†å¤„ç†) */
        .cell:nth-child(9n) {
            border-right: none;
        }

        /* åº•è¾¹æ¡†åŠ ç²— (æ¯3è¡Œ - CSS Gridç¨å¾®å¤æ‚ï¼Œé€šè¿‡ç±»åæ§åˆ¶æ›´ç¨³) */
        .cell.border-bottom-thick {
            border-bottom: 2px solid var(--line-heavy);
        }
        
        .cell.user-input {
            color: var(--text-user);
            font-weight: bold;
        }
        
        .cell.error {
            color: var(--text-error) !important;
            background-color: rgba(231, 76, 60, 0.1);
        }

        .cell.selected {
            background-color: var(--highlight-cell);
        }

        .cell.highlight-same {
            background-color: var(--highlight-same);
        }

        /* é”®ç›˜åŒºåŸŸ */
        .controls {
            width: 94vw;
            max-width: 500px;
            margin-top: 20px;
        }

        .action-btns {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: white;
            color: var(--text-main);
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        
        .btn.primary {
            background: var(--text-main);
            color: white;
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .num-btn {
            aspect-ratio: 1.5/1; /* æ‰ä¸€ç‚¹ */
            border: none;
            background: white;
            border-radius: 5px;
            font-size: 1.5rem;
            color: var(--text-user);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .num-btn:active {
            background: #eee;
        }

        /* èƒœåˆ©å¼¹çª— */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal.show { opacity: 1; pointer-events: auto; }
        .modal h2 { color: var(--text-main); margin-bottom: 20px; }

    </style>
</head>
<body>

    <div class="header">
        <h1>SUDOKU</h1>
        <select id="difficulty" class="difficulty-select">
            <option value="30">ç®€å•</option>
            <option value="40" selected>ä¸­ç­‰</option>
            <option value="50">å›°éš¾</option>
        </select>
    </div>

    <div class="board-wrapper">
        <div id="grid" class="grid">
            </div>
    </div>

    <div class="controls">
        <div class="action-btns">
            <button class="btn" onclick="newGame()">æ–°æ¸¸æˆ</button>
            <button class="btn primary" onclick="getHint()">ğŸ’¡ æç¤º</button>
        </div>

        <div class="numpad">
            <button class="num-btn" onclick="fillNumber(1)">1</button>
            <button class="num-btn" onclick="fillNumber(2)">2</button>
            <button class="num-btn" onclick="fillNumber(3)">3</button>
            <button class="num-btn" onclick="fillNumber(4)">4</button>
            <button class="num-btn" onclick="fillNumber(5)">5</button>
            <button class="num-btn" onclick="fillNumber(6)">6</button>
            <button class="num-btn" onclick="fillNumber(7)">7</button>
            <button class="num-btn" onclick="fillNumber(8)">8</button>
            <button class="num-btn" onclick="fillNumber(9)">9</button>
            <button class="num-btn" onclick="fillNumber(0)" style="color:#e74c3c">Ã—</button>
        </div>
    </div>

    <div id="win-modal" class="modal">
        <h2>ğŸ‰ å®Œæˆï¼</h2>
        <button class="btn primary" onclick="newGame()">å†æ¥ä¸€å±€</button>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let solutionBoard = []; // å®Œæ•´ç­”æ¡ˆ
        let gameBoard = [];     // å½“å‰ç›˜é¢
        let fixedBoard = [];    // åˆå§‹é¢˜ç›®ï¼ˆä¸å¯ä¿®æ”¹éƒ¨åˆ†ï¼‰
        let selectedCellIndex = -1;

        const gridElement = document.getElementById('grid');
        const difficultySelect = document.getElementById('difficulty');
        const modal = document.getElementById('win-modal');

        // --- æ ¸å¿ƒç®—æ³•ï¼šç”Ÿæˆæ•°ç‹¬ ---
        
        function generateSudoku(removeCount) {
            // 1. åˆå§‹åŒ–ç©ºç›˜
            const board = Array(81).fill(0);
            
            // 2. å¡«å……å¯¹è§’çº¿ä¸Šçš„ä¸‰ä¸ª3x3å®«ï¼ˆè¿™ä¸‰ä¸ªå®«æ˜¯ç‹¬ç«‹çš„ï¼Œéšæœºå¡«å…¥åˆæ³•æ•°å­—å³å¯åŠ é€Ÿç”Ÿæˆï¼‰
            fillDiagonalBoxes(board);
            
            // 3. ä½¿ç”¨å›æº¯æ³•è§£å‡ºå‰©ä½™æ ¼å­ï¼Œå¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„ç»ˆç›˜
            solveBoard(board);
            solutionBoard = [...board]; // ä¿å­˜ç­”æ¡ˆ

            // 4. æŒ–æ´ï¼ˆæ ¹æ®éš¾åº¦ç§»é™¤æ•°å­—ï¼‰
            gameBoard = [...board];
            fixedBoard = Array(81).fill(false);

            let attempts = removeCount;
            while (attempts > 0) {
                let idx = Math.floor(Math.random() * 81);
                if (gameBoard[idx] !== 0) {
                    gameBoard[idx] = 0;
                    attempts--;
                }
            }

            // æ ‡è®°å“ªäº›æ˜¯é¢˜ç›®è‡ªå¸¦çš„
            for(let i=0; i<81; i++) {
                if (gameBoard[i] !== 0) fixedBoard[i] = true;
            }
        }

        function fillDiagonalBoxes(board) {
            for (let i = 0; i < 9; i = i + 3) {
                fillBox(board, i, i);
            }
        }

        function fillBox(board, row, col) {
            let num;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    do {
                        num = Math.floor(Math.random() * 9) + 1;
                    } while (!isSafeInBox(board, row, col, num));
                    board[(row + i) * 9 + (col + j)] = num;
                }
            }
        }

        function isSafeInBox(board, rowStart, colStart, num) {
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (board[(rowStart + i) * 9 + (colStart + j)] === num) return false;
                }
            }
            return true;
        }

        function solveBoard(board) {
            for (let i = 0; i < 81; i++) {
                if (board[i] === 0) {
                    for (let num = 1; num <= 9; num++) {
                        if (isSafe(board, i, num)) {
                            board[i] = num;
                            if (solveBoard(board)) return true;
                            board[i] = 0;
                        }
                    }
                    return false;
                }
            }
            return true;
        }

        function isSafe(board, index, num) {
            const row = Math.floor(index / 9);
            const col = index % 9;
            
            // Check Row
            for (let x = 0; x < 9; x++) if (board[row * 9 + x] === num) return false;
            // Check Col
            for (let x = 0; x < 9; x++) if (board[x * 9 + col] === num) return false;
            // Check 3x3 Box
            const startRow = row - row % 3;
            const startCol = col - col % 3;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (board[(startRow + i) * 9 + (startCol + j)] === num) return false;
                }
            }
            return true;
        }

        // --- ç•Œé¢æ¸²æŸ“ä¸äº¤äº’ ---

        function renderBoard() {
            gridElement.innerHTML = '';
            for (let i = 0; i < 81; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                
                // 3x3 ç½‘æ ¼çš„ç²—è¾¹æ¡†å¤„ç†
                const row = Math.floor(i / 9);
                if (row === 2 || row === 5) {
                    cell.classList.add('border-bottom-thick');
                }

                // å¡«å……å†…å®¹
                if (gameBoard[i] !== 0) {
                    cell.textContent = gameBoard[i];
                    if (!fixedBoard[i]) {
                        cell.classList.add('user-input');
                        // æ£€æŸ¥é”™è¯¯
                        if(gameBoard[i] !== solutionBoard[i]) {
                            cell.classList.add('error');
                        }
                    } else {
                        // é¢˜ç›®è‡ªå¸¦çš„æ•°å­—
                        cell.style.fontWeight = '500'; 
                    }
                }

                cell.onclick = () => selectCell(i);
                gridElement.appendChild(cell);
            }
        }

        function selectCell(index) {
            selectedCellIndex = index;
            
            // ç§»é™¤æ‰€æœ‰æ—§çš„é«˜äº®
            document.querySelectorAll('.cell').forEach(c => {
                c.classList.remove('selected');
                c.classList.remove('highlight-same');
            });

            const cells = document.querySelectorAll('.cell');
            cells[index].classList.add('selected');

            // é«˜äº®ç›¸åŒçš„æ•°å­—
            const val = gameBoard[index];
            if (val !== 0) {
                for(let i=0; i<81; i++) {
                    if(gameBoard[i] === val) {
                        cells[i].classList.add('highlight-same');
                    }
                }
            }
        }

        function fillNumber(num) {
            if (selectedCellIndex === -1) return;
            if (fixedBoard[selectedCellIndex]) return; // ä¸å¯ä¿®æ”¹é¢˜ç›®

            // 0 ä»£è¡¨æ¸…é™¤
            gameBoard[selectedCellIndex] = num === 0 ? 0 : num;
            
            renderBoard();
            selectCell(selectedCellIndex); // ä¿æŒé€‰ä¸­çŠ¶æ€
            
            checkWin();
        }

        function getHint() {
            // é€»è¾‘ï¼šä¼˜å…ˆå¡«è¡¥å½“å‰é€‰ä¸­çš„æ ¼å­ã€‚å¦‚æœå½“å‰æœªé€‰ä¸­æˆ–å·²å¡«å¯¹ï¼Œåˆ™éšæœºå¡«ä¸€ä¸ªç©ºçš„ã€‚
            
            let targetIndex = selectedCellIndex;

            // å¦‚æœæ²¡é€‰ä¸­ï¼Œæˆ–è€…é€‰ä¸­çš„å·²ç»æ˜¯å¯¹çš„ï¼Œæˆ–è€…é€‰ä¸­çš„æ˜¯é¢˜ç›®ï¼Œåˆ™å¯»æ‰¾ä¸€ä¸ªç©ºä½
            if (targetIndex === -1 || 
                fixedBoard[targetIndex] || 
                gameBoard[targetIndex] === solutionBoard[targetIndex]) {
                
                // æ‰¾ä¸€ä¸ªç©ºçš„æˆ–è€…é”™çš„æ ¼å­
                const emptyIndices = [];
                for(let i=0; i<81; i++) {
                    if(gameBoard[i] !== solutionBoard[i]) {
                        emptyIndices.push(i);
                    }
                }
                
                if(emptyIndices.length === 0) return; // å·²ç»å…¨å¯¹
                targetIndex = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
            }

            // å¡«å…¥æ­£ç¡®ç­”æ¡ˆ
            gameBoard[targetIndex] = solutionBoard[targetIndex];
            renderBoard();
            selectCell(targetIndex);
            checkWin();
        }

        function checkWin() {
            // ç®€å•åˆ¤æ–­ï¼šæ˜¯å¦æ‰€æœ‰æ ¼å­éƒ½å¡«æ»¡ä¸”æ²¡æœ‰é”™è¯¯ç±»
            for(let i=0; i<81; i++) {
                if(gameBoard[i] !== solutionBoard[i]) return;
            }
            // èƒœåˆ©
            setTimeout(() => {
                modal.classList.add('show');
            }, 300);
        }

        function newGame() {
            modal.classList.remove('show');
            const holes = parseInt(difficultySelect.value);
            generateSudoku(holes);
            selectedCellIndex = -1;
            renderBoard();
        }

        // åˆå§‹åŒ–
        newGame();

        // é˜²æ­¢åŒå‡»ç¼©æ”¾
        document.addEventListener('dblclick', function(event) {
            event.preventDefault();
        }, { passive: false });

    </script>
</body>
</html>